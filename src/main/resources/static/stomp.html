<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>STOMP 채팅</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
</head>
<body>
<h1>STOMP 채팅</h1>

<!-- 사용자 ID 입력 -->
<div id="login-container">
  <input id="userId" placeholder="사용자 ID를 입력하세요"/>
  <button onclick="connectWebSocket()">연결</button>
</div>

<!-- 채팅 입력 및 전송 -->
<div id="chat-container" style="display:none;">
  <p id="welcome-message"></p>
  <div id="user-list-container">
    <strong>채팅 내용:</strong>
    <ul id="chat"></ul>
  </div>
  <input id="message" placeholder="메시지를 입력하세요"/>
  <button onclick="sendMessage()">전송</button>
</div>

<script>
  let stompClient;
  let userId;

  // 웹소켓 연결
  function connectWebSocket() {
    userId = document.getElementById("userId").value.trim();
    if (!userId) {
      alert("사용자 ID를 입력하세요!");
      return;
    }

    const socket = new SockJS("http://192.168.7.5:8080/stomp/chat");
    stompClient = Stomp.over(socket);

    stompClient.connect({}, () => {
      console.log("STOMP 연결 완료!");

      // 입장 메시지 전송
      stompClient.send("/app/enter", {}, userId);

      // 채팅 구독
      stompClient.subscribe("/topic/chat", (message) => {
        const chatBox = document.getElementById("chat");
        const newMessage = document.createElement("li");
        newMessage.textContent = message.body;
        chatBox.appendChild(newMessage);
      });

      document.getElementById("login-container").style.display = "none";
      document.getElementById("chat-container").style.display = "block";
      document.getElementById("welcome-message").innerText = `${userId}님, 환영합니다!`;
    });

    // 퇴장 시 처리
    window.onbeforeunload = () => {
      stompClient.send("/app/leave", {}, userId); // 퇴장 메시지 전송
    };
  }

  // 메시지 전송
  function sendMessage() {
    const input = document.getElementById("message");
    const message = input.value;

    if (message.trim() === "") return;

    const chatMessage = {
      userId: userId,
      content: message
    };

    stompClient.send("/app/message", {}, JSON.stringify(chatMessage));
    input.value = '';
  }
</script>
</body>
</html>
